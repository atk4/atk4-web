<?$Content?>

<div class="g-row" id="doc-ref">
	<div class="g-12">

<h1>Creating User Interface</h1>
<p>What we just did is the very basics of the User Interface - only the start. Since we got our client all excited let's listen
to our further requirements or "user stories" how they properly call them in Agile Development.</p>

<quote>Users need to be able to access this interface themselves. Not all of it, of course, but only the part to see which
DVDs are available. They also should be able to see what they have rented currently and in the past.</quote>

<p>Not mutch, but let's try to split it into the list of the further tasks we will focus on:

<ul>
<li>Users certainly need their own login. Need to add email / password fields into database and turn on authentication</li>
<li>Registration of new users is probably needed</li>
<li>When logged in, users should see our dashboard screen with a couple of grids</li>
</ul>


<h2>Setting up Manager's interface</h2>
<p>
Right now we have added just added the pages for how they are, but it would be probably a good idea to separate them a
separate interface only available to the managers. To do that, we will create new Application Class, which will have it's
own authentication rules and its own pages, but would share models. We could have simply protected a few pages, but there
are way many obstacles down this road - difference in design, access level, menu structure and static pages.
</p>

<p>Create a completely new directory called "admin" and inside there place the following files:</p>
<h6>index.php</h6>
<?Code?>
include '../atk4/loader.php';
$api=new Admin('rentaladmin','default');
$api->main();
<?/?>
<h6>config.php</h6>
<?Code?>
$config['atk']['base_path']='../atk4/';
$config['dsn']='mysql://root:root@localhost/project'; // use your own
$config['url_postfix']='';
$config['url_prefix']='?page=';
<?/?>
<h6>lib/Frontend.php</h6>
<?Code?>
class Admin extends ApiFrontend {

    public $is_admin=true;
    
    function init(){
        parent::init();
        $this->dbConnect();

        $this->addLocation('..',array(
                    'php'=>array(
                        'lib',
                        'atk4-addons/mvc',
                        'atk4-addons/billing/lib',
                        'atk4-addons/misc/lib',
                        )
                    ))
            ->setParent($this->pathfinder->base_location);

        $this->add('jUI');
        $this->js()
            ->_load('atk4_univ')
            ->_load('ui.atk4_notify')
            ;

        // Allow user: "admin", with password: "demo" to use this application
        $this->add('BasicAuth')->allow('admin','demo')->check();

        $menu=$this->add('Menu',null,'Menu');
        $menu->addMenuItem('Schema Generator','sg');
        $menu->addMenuItem('Manager','mgr');

        $this->initLayout();
    }
    function page_index($p){
        $this->api->redirect('mgr');
    }
}
<?/?>
<p>after you are done, move page/mgr.php into admin/page/mrg.php and page/sg.php into admin/page/sg.php. You should be able now to add /admin/ at the end of your URL and be able to access your brand new administration interface. Location engine will properly look for models in the main lib directory, but pages must be defined locally to avoid unauthorized access.</p>

<p>With admin pages out of the way, we can now create authentication for our front-end users. Before that, however, we would need to perform database migration (alters). and the best way to do so would be to use "dbupdate" techniques.</p>

<h2>Adding password for users</h2>
<p>First, make sure you have a "doc" folder in your top-level directory. Create a .htaccess file inside it to restrict direct access (you can also keep the folder outside of your web root). Database migration requires you to have "bash" which comes with any unix or linux. If you are on windows, you can install cygwin or bash, or execute upgrade files manually. The reason why upgardes are done through the command-line is because in secure environment you would have a separate username with create/alter priviledges and database user from config.php wouldn't be able to perform those operations.</p>

<p>create file doc/rental-001.sql. This is a base version of database. Create file doc/dbupdates/rental-001-01.sql containing:</p>

<div class="atk_doc example"><code><pre>
alter table customer add email varchar(255);
alter table customer add password varchar(255);
</pre></code></div>

<p>Next you would need to copy, or sym-link atk4/tools/update.sh into doc/ and execute it. If it complains about missing 'config.php', then copy config-defaults.php into config.php. You should see this in your terminal:</p>

<div class="atk_doc example"><code><pre>
$ cd doc/
$ ln -s ../atk4/tools/update.sh .
$ ./update.sh 
cat: ../../../config.php: No such file or directory
Error: Can't read config file
$ cd ..
$ cp config-default.php config.php

$ cd doc/
$ ./update.sh 
* Applying updates on database 'project'
 rental-001-01.sql... ok
* Done
$ 
</pre></code></div>
<p>Next you need to update customer's models by defining new field "email". We specifically leave out password from the model. This way UI elements will not be able to access it.</p>

<?Code?>
// add into lib/Model/Customer.php, init():

$this->addField('email');
<?/?>

<p>And finally admin should be able to set passwords. Let's first create a model function for Model_Customer:</p>
<?Code?>
    function changePassword($new,$old=null){

        // Not admin, check for old password

        $dq=$this->api->db->dsql();
        $userdata=$dq
            ->where('id',$this->get('id'))
            ->field('email,password')
            ->do_getHash();

        $auth=$this->add('UserAuth');
        if(!$this->api->is_admin){
            if(!$auth->verifyCredintials($userdata['email'],
                        $auth->encryptPassword($userdata['password'],$userdata['email']))){
                throw $this->exception('Password incorrect','ValidityCheck')->setField('password');
            }

        }
        // set to the new password now
        $newpass=$auth->encryptPassword($new,$username['email']);

        // reuse same query to make sure condition is same
        $dq->set('password',$newpass)->do_update();
    }
<?/?>

<p>Since we referr to UserAuth here, we also need to define that class by placing it into our webroot/lib folder. It will make sure we are using consistent authentication between frontend and backend.</p>
<?Code?>
class UserAuth extends SQLAuth {
    function init(){
        parent::init();
        // can also use sha1 or md5 or comment encryption completely
        $this->usePasswordEncryption('sha256/salt');
    }
}
<?/?>

<p>After you add any function to the model it's highly recommended to create a test-script. But as we are not doing that now, we would need to create testscripts after. Let's create user interface part for changing password instead. How about adding a button to CRUD for password change. Back to admin/page/mgr.php</p>

<?Code?>
    function initMainPage(){

        $tabs=$this->add('Tabs');

        $crud_customers=$tabs->addTab('Customers')->add('CRUD');
        $crud_customers->setModel('Customer');
        if($crud_customers->grid){
            $crud_customers->grid->addColumn('expander','pass','Reset Password');
        }

        $tabs->addTab('Movies')->add('CRUD')->setModel('Movie');
        $tabs->addTab('DVDs')->add('CRUD')->setModel('DVD');
        $tabs->addTab('Rentals')->add('CRUD')->setModel('Rental');
    }
    function page_pass(){
        $form=$this->add('Form');
        $this->api->stickyGET('customer_id');
        $form->addField('password','pass','New Password');
        $form->addSubmit('Change');
        $form->onSubmit(function($form){
            $cust=$form->add('Model_Customer');
            $cust->loadData($_GET['customer_id']);
            $cust->changePassword($form->get('pass'));
            return $form->js()->univ()->closeExpander()->successMessage('Password Changed');
        });
    }
<?/?>

<p>Above is a state of the art AJAX functionality created with dozen lines of PHP code. Here we are also using onSubmit() function which will automaticaly capture Exception_ValidityCheck and display errors on the forms.</p>

<?MoreInfo?>Password is common functionality. Isn't it a lot to do for simple functionality?
<p>Agile Toolkit designed not to limit developer in any way. Password changing routine might have been different, encryption and field names might have been different as well as the user interface or responses in password change might have been different. If you find that this technique works for you, you can create extension for the CRUD class which specifically targets editing of Users. You can also create a User super-model which would define changePassword functionality in the way described here or any other way you like.</p>
<p>Once you do that, you can re-use that piece of code in all of your applications or share with others in form of "addon"</p>
<?/?>


<h2>Front-end</h2>
<p>Let's quickly create a basic dashboard page protected with Login and along with registration page. We would also need a static page to explain what the service is about.</p>

<p>Be sure to check that your are using "default" skin not "jui" in your webroot/index.php file (it's 2nd argument to Application constructor. "jui" was default in 4.0 version of Agile Toolkit). Next you will need to create few files:</p>

<h6>templates/default/index.html</h6>
<div class="atk_doc example"><code><pre>


<div class="g-row">
	<div class="g-8">
        <p>Welcome to the DVD revtal program. Lorem ipsum dolor sit amet</p>
    </div>
    <div class="g-4">
        <?LoginForm?>
    </div>
</div>



</pre></code></div>


</div></div>
<?$Next?>
